(async()=>{for(;!Spicetify.React||!Spicetify.ReactDOM;)await new Promise(e=>setTimeout(e,10));var a,i,n,s,o,r,l,d,c,u,p,f,A,g,y,N,m,h,M,v,e;function q(){var e;try{var t,i=Spicetify.LocalStorage.get(u);return i?{autoEnabled:null!=(e=(t=JSON.parse(i)).autoEnabled)?e:p.autoEnabled,autoIntervalMs:("number"==typeof t.autoIntervalMs&&0<t.autoIntervalMs?t:p).autoIntervalMs,maxAutosnapshots:("number"==typeof t.maxAutosnapshots&&0<t.maxAutosnapshots?t:p).maxAutosnapshots,autoMode:"timer"===t.autoMode?"timer":"on-change",onlyNewItems:!1!==t.onlyNewItems,queueWarnEnabled:!1!==t.queueWarnEnabled,queueMaxSize:("number"==typeof t.queueMaxSize&&1<t.queueMaxSize?t:p).queueMaxSize,queueWarnThreshold:("number"==typeof t.queueWarnThreshold&&0<=t.queueWarnThreshold?t:p).queueWarnThreshold}:p}catch(e){return p}}function I(){try{var e,t=Spicetify.LocalStorage.get(f);return t?(e=JSON.parse(t),Array.isArray(e)?e:[]):[]}catch(e){return[]}}function t(e){return e.sort((e,t)=>t.createdAt-e.createdAt)}function j(e){t(e),Spicetify.LocalStorage.set(f,JSON.stringify(e))}function x(){return t(I())}function D(e,t){var t=null!=t?t:q(),i=I(),a=i.filter(e=>"manual"===e.type),i=i.filter(e=>"auto"===e.type);"auto"===e.type?(t=[e,...i].slice(0,t.maxAutosnapshots),j([...a,...t])):j([e,...a,...i])}function P(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function L(e,t){var i=e.querySelector(".qs-btn-label");i?i.textContent=t:e.textContent=t}function R(){return Date.now()+"-"+Math.random().toString(36).slice(2,8)}async function z(e,t){try{var i=JSON.stringify(t,null,2),a=new Blob([i],{type:"application/json"}),n=window;if(n&&"function"==typeof n.showSaveFilePicker)try{var s=await(await n.showSaveFilePicker({suggestedName:e,types:[{description:"JSON Files",accept:{"application/json":[".json"]}}]})).createWritable();return await s.write(a),void await s.close()}catch(e){if(e&&("AbortError"===e.name||"NotAllowedError"===e.name))return void Spicetify.showNotification(A+": Export canceled")}var o=URL.createObjectURL(a),r=document.createElement("a");r.href=o,r.download=e,document.body.appendChild(r),r.click(),r.remove(),URL.revokeObjectURL(o),Spicetify.showNotification(A+`: Exported ${e} to Downloads folder`)}catch(e){console.warn(A+": downloadJson failed",e),Spicetify.showNotification(A+": Failed to export JSON")}}async function C(t){let i,n=new Array(t.length).fill(""),s=[],o=[];t.forEach((e,t)=>{var i,a;e.startsWith("spotify:local:")?n[t]=(t=>{var i=(t=t.split(":"))[2]||"Local",t=t[4]||"track";try{return decodeURIComponent(i.replace(/\+/g," "))+" - "+decodeURIComponent(t.replace(/\+/g," "))}catch(e){return i+" - "+t}})(e):({type:i,id:a}=(e=>{if(3<=(e=e.split(":")).length){if("track"===e[1])return{type:"track",id:e[2]};if("episode"===e[1])return{type:"episode",id:e[2]}}return{type:null,id:null}})(e),"track"===i&&a?s.push({idx:t,id:a}):"episode"===i&&a?o.push({idx:t,id:a}):n[t]=e)});for(let e=0;e<s.length;e+=50){var a=s.slice(e,e+50),r=a.map(e=>e.id).join(",");try{var l,d,c,u,p=await Spicetify.CosmosAsync.get("https://api.spotify.com/v1/tracks?ids="+r),f=Array.isArray(null==p?void 0:p.tracks)?p.tracks:[],g=new Map;for(l of f)null!=l&&l.id&&null!=l&&l.name&&(c=(d=Array.isArray(null==l?void 0:l.artists)?l.artists.map(e=>null==e?void 0:e.name).filter(Boolean).join(", "):"")?d+" - "+l.name:l.name,g.set(l.id,c));for(u of a)n[u.idx]=g.get(u.id)||t[u.idx]}catch(e){for(var y of a)n[y.idx]=t[y.idx]}}if(o.length)for(let e=0;e<o.length;e+=50){var m=o.slice(e,e+50),h=m.map(e=>e.id).join(",");try{var v,q,x,b,w=await Spicetify.CosmosAsync.get("https://api.spotify.com/v1/episodes?ids="+h),S=Array.isArray(null==w?void 0:w.episodes)?w.episodes:[],$=new Map;for(v of S)null!=v&&v.id&&null!=v&&v.name&&(x=(q=null==(i=null==v?void 0:v.show)?void 0:i.name)?q+" - "+v.name:v.name,$.set(v.id,x));for(b of m)n[b.idx]=$.get(b.id)||t[b.idx]}catch(e){for(var k of m)n[k.idx]=t[k.idx]}}return n}function F(e){return("auto"===e.type?"Auto":"Manual")+" "+(t=>{try{return new Date(t).toLocaleString()}catch(e){return""+t}})(e.createdAt)}function W(e){return e.name||F(e)}function b(e){return"string"==typeof e&&e.startsWith("spotify:")?e:e&&"string"==typeof e.uri&&e.uri.startsWith("spotify:")?e.uri:e&&e.contextTrack&&"string"==typeof e.contextTrack.uri&&e.contextTrack.uri.startsWith("spotify:")?e.contextTrack.uri:e&&e.track&&"string"==typeof e.track.uri&&e.track.uri.startsWith("spotify:")?e.track.uri:e&&e.item&&"string"==typeof e.item.uri&&e.item.uri.startsWith("spotify:")?e.item.uri:null}function T(){var t,i,a;try{var n,s=Spicetify.Queue,o=[],r=b(null==s?void 0:s.track)||b(null==(i=null==(t=Spicetify.Player)?void 0:t.data)?void 0:i.item),l=(r&&o.push(r),(null==s?void 0:s.nextTracks)||[]);let e=0;for(n of Array.isArray(l)?l:[]){var d,c=null==n?void 0:n.provider,u=(null==(a=null==n?void 0:n.contextTrack)?void 0:a.metadata)||(null==n?void 0:n.metadata),p=!0===(null==u?void 0:u.is_queued)||"true"===(null==u?void 0:u.is_queued);("queue"===c||p)&&(d=b(n))&&(o.push(d),e++)}var f=o.length?(e=>{var t,i=[];let a=null;for(t of e)t&&t!==a&&i.push(t),a=t;return i})(o):[];return console.log(A+": Spicetify.Queue -> now=%s queuedNext=%d total=%d",Boolean(r),e,f.length),f}catch(e){return console.error(A+": Spicetify.Queue read failed",e),[]}}function w(e,t=v){var i=(null!=(i=Spicetify.SVGIcons)?i:{})[e];return i?`<span class="qs-btn-icon" data-icon-name="${P(e)}"><svg class="qs-svg-icon" viewBox="0 0 16 16" aria-hidden="true" focusable="false" style="width:${t}px;height:${t}px;">${i}</svg></span>`:""}function S(e,t,i={}){var{action:i,id:a,tone:n="default",title:s}=i,o=["qs-btn"],n=("danger"===n&&o.push("danger"),"primary"===n&&o.push("primary"),"subtle"===n&&o.push("subtle"),[]),i=(i&&n.push(`data-action="${i}"`),a&&n.push(`id="${a}"`),s&&n.push(`title="${P(s)}"`),n.length?" "+n.join(" "):""),a=t?w(t):"";return`<button type="button" class="${o.join(" ")}"${i}>${a}<span class="qs-btn-label">${P(e)}</span></button>`}function E(e,t,i){return`<button type="button" class="qs-icon-btn" data-action="${P(e)}" title="${P(i)}">${w(t)}</button>`}function $(e,t="default"){return`<span class="${"accent"===t?"qs-pill qs-pill--accent":"qs-pill"}">${P(e)}</span>`}function U(e){return e.map(e=>{var t=P(W(e)),i=e.items.some(e=>e.startsWith("spotify:local:")),a=[$(e.items.length+" "+(1===e.items.length?"item":"items"),"accent")],i=(i&&a.push($("includes local")),a.join(""));return`
          <div class="qs-row" data-id="${e.id}">
            <div class="qs-row-main">
              <div class="qs-row-title">
                ${w("auto"===e.type?"clock":"playlist")}
                <span>${t}</span>
                <span class="qs-title-actions">
                  ${E("rename","edit","Rename snapshot")}
                  ${e.name?E("reset-name","repeat","Reset name"):""}
                </span>
              </div>
              <div class="qs-row-meta">${i}</div>
              <div class="qs-row-actions">
                ${S("View items","list-view",{action:"toggle-items",title:"Toggle items"})}
                ${S("Replace queue","queue",{action:"replace-queue",tone:"primary"})}
                ${S("Export","download",{action:"export",title:"Export to playlist"})}
                ${S("Delete","minus",{action:"delete",tone:"danger"})}
              </div>
            </div>
          </div>
          <div class="qs-items" data-id="${e.id}" style="display:none">
            <div class="qs-items-body">Loading…</div>
          </div>
        `}).join("")}function Q(){var e=x(),t=e.filter(e=>"auto"===e.type),e=e.filter(e=>"manual"===e.type),i=U(t),a=U(e);return`
      <div class="qs-section-card">
        <div class="qs-section-head">
          <div class="qs-section-heading">
            ${w("playlist")}
            <div class="qs-section-text">
              <div class="qs-section-name">Manual Snapshots</div>
              <div class="qs-section-caption">Your saved queues for later</div>
            </div>
            ${$(String(e.length),"accent")}
          </div>
          <div class="qs-actions">
            ${S("Export all","download",{id:"qs-export-manuals",tone:"subtle"})}
            ${S("Save now","plus-alt",{id:"qs-new-manual",tone:"primary"})}
          </div>
        </div>
        <div class="qs-section-body">
          ${a||'<div class="qs-empty">No manual snapshots yet</div>'}
        </div>
      </div>
      <div class="qs-section-card">
        <div class="qs-section-head">
          <div class="qs-section-heading">
            ${w("clock")}
            <div class="qs-section-text">
              <div class="qs-section-name">Automatic Snapshots</div>
              <div class="qs-section-caption">Captured in the background</div>
            </div>
            ${$(String(t.length),"accent")}
          </div>
          <div class="qs-actions">
            ${S("Export all","download",{id:"qs-export-autos",tone:"subtle"})}
          </div>
        </div>
        <div class="qs-section-body">
          ${i||'<div class="qs-empty">No automatic snapshots yet</div>'}
        </div>
      </div>
    `}function k(E){var e=`<span class="qs-pill qs-pill--version">${P("v"+g)}</span>`,t=y?`<span class="qs-pill qs-pill--channel">${P(y.toUpperCase())}</span>`:"",i=Q(),a=E.getSettings(),e=`
      <div class="qs-container">
        <div class="qs-header">
          <div class="qs-header-title">
            <div class="qs-header-icon">${w("queue",20)}</div>
            <span class="qs-header-badges">${e}${t}</span>
          </div>
          <div class="qs-actions">
            ${S("Refresh","repeat",{id:"qs-refresh",tone:"subtle"})}
            ${S("Export settings","download",{id:"qs-export-settings"})}
          </div>
        </div>
        <div class="qs-settings">
          <div class="qs-settings-header">
            <div class="qs-section-heading">
              ${w("grid-view")}
              <div class="qs-section-text">
                <div class="qs-section-name">Settings</div>
                <div class="qs-section-caption">Tune automation and queue alerts</div>
              </div>
            </div>
          </div>
          <div class="qs-setting">
              <label class="qs-checkbox"><input type="checkbox" id="qs-auto-enabled" ${a.autoEnabled?"checked":""}/> ${w("brightness")}Enable automatic snapshots</label>
            <div class="qs-dim">Mode 
              <div class="qs-radio-group" id="qs-auto-mode-group">
                <label class="qs-radio-label"><input type="radio" class="qs-radio" name="qs-auto-mode" value="timer" ${"timer"===a.autoMode?"checked":""} ${a.autoEnabled?"":"disabled"}/><span>${w("clock")} Time-based</span></label>
                <label class="qs-radio-label"><input type="radio" class="qs-radio" name="qs-auto-mode" value="on-change" ${"on-change"===a.autoMode?"checked":""} ${a.autoEnabled?"":"disabled"}/><span>${w("shuffle")} Queue changes</span><span class="qs-icon"><span class="qs-icon-glyph">ⓘ</span><span class="qs-tooltip"><span class="qs-tooltip-emph">Experimental</span>: this mode may create many similar snapshots (for example when queuing a bunch of songs)</span></span></label>
              </div>
            </div>
            <div class="qs-setting" style="margin-top:6px">
              <label class="qs-checkbox"><input type="checkbox" id="qs-only-new" ${a.onlyNewItems?"checked":""} ${a.autoEnabled?"":"disabled"}/> ${w("search")} Check for new items</label>
              <div style="opacity:0.7; font-size:12px">Only trigger it when there is a new song that was not in the previous snapshot.</div>
            </div>
            <div class="qs-setting" style="margin-top:6px">
              <div style="opacity:0.7; font-size:12px">Equal queues are never saved as automatic snapshots.</div>
            </div>
            <div class="qs-setting" style="margin-top:12px">
              <label class="qs-checkbox"><input type="checkbox" id="qs-queue-warn-enabled" ${!1!==a.queueWarnEnabled?"checked":""}/> ${w("exclamation-circle")} Warn when queue is nearly full</label>
              <div style="opacity:0.7; font-size:12px">Heuristic limit; includes current track. Adjust if needed.</div>
            </div>
          </div>
          <div class="qs-right">
            <div class="qs-setting">
              <label>${w("clock")} Interval (minutes)</label>
              <input class="qs-input" type="number" id="qs-auto-interval-mins" min="0.5" step="0.5" value="${(a.autoIntervalMs/6e4).toFixed(2)}" ${a.autoEnabled&&"timer"===a.autoMode?"":"disabled"} />
              <div style="opacity:0.7; font-size:12px">Minimum 0.5 (30 seconds)</div>
            </div>
            <div class="qs-setting">
              <label>${w("chart-up")} Max automatic snapshots</label>
              <input class="qs-input" type="number" id="qs-max-autos" min="1" step="1" value="${a.maxAutosnapshots}" ${a.autoEnabled?"":"disabled"} />
              <div style="opacity:0.7; font-size:12px">Older snapshots are pruned</div>
            </div>
            <div class="qs-setting">
              <label>${w("queue")} Queue max size</label>
              <input class="qs-input" type="number" id="qs-queue-max-size" min="10" step="1" value="${null!=(e=a.queueMaxSize)?e:80}" ${!1!==a.queueWarnEnabled?"":"disabled"} />
            </div>
            <div class="qs-setting">
              <label>${w("exclamation-circle")} Warn when remaining slots ≤</label>
              <input class="qs-input" type="number" id="qs-queue-warn-threshold" min="0" step="1" value="${null!=(t=a.queueWarnThreshold)?t:5}" ${!1!==a.queueWarnEnabled?"":"disabled"} />
            </div>
          </div>
        </div>
        <div id="qs-list">
          ${i||'<div style="opacity:0.7">No snapshots yet</div>'}
        </div>
      </div>
    `;function n(){let t=E.getSettings();var e=document.querySelectorAll('input.qs-radio[name="qs-auto-mode"]'),i=document.querySelector("#qs-auto-interval-mins"),a=document.querySelector("#qs-only-new"),n=document.querySelector("#qs-max-autos"),s=document.querySelector("#qs-queue-max-size"),o=document.querySelector("#qs-queue-warn-threshold"),e=(e.forEach(e=>{e.disabled=!t.autoEnabled}),i&&(i.disabled=!(t.autoEnabled&&"timer"===t.autoMode)),a&&(a.disabled=!t.autoEnabled),n&&(n.disabled=!t.autoEnabled),!1!==t.queueWarnEnabled);s&&(s.disabled=!e),o&&(o.disabled=!e)}Spicetify.PopupModal.display({title:A,content:e,isLarge:!0}),m&&(document.removeEventListener("click",m,!0),m=null),h&&(document.removeEventListener("change",h,!0),h=null),m=async function(e){var i=document.querySelector(".qs-container"),a=e.target;if(i&&a&&i.contains(a)&&e.stopPropagation(),i&&a){var t,i=a.closest(".qs-btn, .qs-icon-btn");if("qs-new-manual"===(null==i?void 0:i.id)){e.preventDefault();try{var n,s=await T();s.length?(n=F({type:"manual",createdAt:Date.now()}),(o=null==(t=window.prompt)?void 0:t.call(window,"Name this snapshot:",n))?(D({id:R(),createdAt:Date.now(),name:o,type:"manual",items:s}),Spicetify.showNotification(A+": Snapshot saved")):Spicetify.showNotification(A+": Snapshot not saved (no name provided)")):Spicetify.showNotification(A+": No queue found. If you believe this is an error, please try to play and pause a track.")}catch(e){console.error(A+": manual snapshot failed",e),Spicetify.showNotification(A+": Failed to save snapshot")}await 0,O()}else{if("qs-export-settings"===(null==i?void 0:i.id))return e.preventDefault(),a=E.getSettings(),z(A+"-settings.json",a);if("qs-export-manuals"===(null==i?void 0:i.id))return e.preventDefault(),t=I().filter(e=>"manual"===e.type),z(A+"-manual-snapshots.json",t);if("qs-export-autos"===(null==i?void 0:i.id))return e.preventDefault(),n=I().filter(e=>"auto"===e.type),z(A+"-auto-snapshots.json",n);if("qs-refresh"===(null==i?void 0:i.id))e.preventDefault(),O();else if(i){var o=i.closest(".qs-row"),a=null!=(s=i.getAttribute("data-action"))?s:void 0,r=i.classList.contains("qs-icon-btn");if(o&&(a||!r)){let t=o.getAttribute("data-id");if(t){var l=I().find(e=>e.id===t);if(l){if(r)return"rename"===a?(e.preventDefault(),null===(r=prompt("Enter a new name.",W(l)))?void 0:0===(r=r.trim()).length?void Spicetify.showNotification("Name cannot be empty",!0,2e3):void(0<=(p=(u=I()).findIndex(e=>e.id===t))&&(u[p].name=r,j(u),O()))):"reset-name"===a?(e.preventDefault(),void(0<=(r=(p=I()).findIndex(e=>e.id===t))&&(delete p[r].name,j(p),O()))):void 0;var d,c,u=a;if(u)if("toggle-items"===u){e.preventDefault();var r=o.nextElementSibling,p=i;if(r&&r.classList.contains("qs-items"))if("none"===r.style.display||!r.style.display){r.style.display="block",L(p,"Hide items");a=r.querySelector(".qs-items-body");if(a){a.textContent="Loading…";try{d=l;var f=await(N.has(d.id)?N.get(d.id):(c=await C(d.items),N.set(d.id,c),c));a.innerHTML=f.map((e,t)=>`<div>${t+1}. ${P(e)}</div>`).join("")}catch(e){a.textContent="Failed to load items"}}}else r.style.display="none",L(p,"View items")}else if("export"===u){if(!M.has(t)){M.add(t);var g=l,e=i;try{if(g.items.length){e&&(e.disabled=!0,L(e,"Exporting…"));var y=await Spicetify.CosmosAsync.get("https://api.spotify.com/v1/me"),m=null==y?void 0:y.id;if(!m)throw new Error("No user id");var h=W(g),v=await Spicetify.CosmosAsync.post(`https://api.spotify.com/v1/users/${encodeURIComponent(m)}/playlists`,{name:h,description:`Saved from ${A} on `+new Date(g.createdAt).toLocaleString(),public:!1}),q=null==v?void 0:v.id;if(!q)throw new Error("Playlist creation failed");var x="spotify:playlist:"+q;let t=0;var b=g.items.length;for(let e=0;e<g.items.length;e+=100){var w=g.items.slice(e,e+100);try{await Spicetify.Platform.PlaylistAPI.add(x,w,{after:"end"}),t+=w.length}catch(e){console.warn(A+": failed to add a chunk",e)}}if(t===b){Spicetify.showNotification(A+": Exported to "+h);try{var S=Spicetify.URI.playlistV2URI(q),$=null==S?void 0:S.toURLPath(!0),k=Spicetify.Platform.History;if($)if(null!=k&&k.push)try{k.push($)}catch(e){k.push({pathname:$})}else window.location.hash=$}catch(e){}}else Spicetify.showNotification(`${A}: Exported; some tracks couldn't be added (${t}/${b})`);try{console.log(A+": Export result",{snapshotId:g.id,totalExpected:b,totalAdded:t})}catch(e){}}else Spicetify.showNotification(A+": Nothing to export")}catch(e){console.error(A+": export failed",e),Spicetify.showNotification(A+": Failed to export to playlist")}finally{e&&(e.disabled=!1,L(e,"Export"))}await 0,M.delete(t)}}else{if("replace-queue"===u)return M.has(t)?void 0:(M.add(t),await(async(e,i)=>{try{if(e.items.length){i&&(i.disabled=!0,L(i,"Replacing…"));var a=e.items.slice(),n=a.shift();try{await Spicetify.Platform.PlayerAPI.clearQueue()}catch(e){console.warn(A+": clearQueue failed (non-fatal)",e)}try{await Spicetify.Player.playUri(n)}catch(e){try{await Spicetify.Platform.PlayerAPI.play({uri:n},{},{})}catch(e){return console.warn(A+": failed to start first track",e),void Spicetify.showNotification(A+": Failed to start snapshot")}}await new Promise(e=>setTimeout(e,250));let t=0;for(let e=0;e<a.length;e+=100){var s=a.slice(e,e+100).map(e=>({uri:e}));try{await Spicetify.Platform.PlayerAPI.addToQueue(s),t+=s.length}catch(e){console.warn(A+": addToQueue chunk failed",e)}}t===a.length?Spicetify.showNotification(`${A}: Queue replaced (${e.items.length} items)`):Spicetify.showNotification(`${A}: Replaced; some items couldn't be queued (${t+1}/${e.items.length})`)}else Spicetify.showNotification(A+": Snapshot is empty")}catch(e){console.error(A+": replace queue failed",e),Spicetify.showNotification(A+": Failed to replace queue")}finally{i&&(i.disabled=!1,L(i,"Replace queue"))}})(l,i),void M.delete(t));"delete"===u&&(j(I().filter(e=>e.id!==t)),O())}}}}}}}},h=function(e){var t,i=document.querySelector(".qs-container"),a=e.target;i&&a&&i.contains(a)&&(e.stopPropagation(),"qs-auto-enabled"===a.id?(i=!!a.checked,e=E.getSettings(),e=c(d({},e),{autoEnabled:i}),E.setSettings(e),n()):"qs-auto-mode"===a.name?(i=a,e=E.getSettings(),i="on-change"===i.value?"on-change":"timer",e=c(d({},e),{autoMode:i}),E.setSettings(e),n()):"qs-only-new"===a.id?(i=!!a.checked,e=E.getSettings(),e=c(d({},e),{onlyNewItems:i}),E.setSettings(e)):"qs-auto-interval-mins"===a.id?(i=a,e=E.getSettings(),i=parseFloat(i.value),i=isFinite(i)&&.5<=i?i:e.autoIntervalMs/6e4,e=c(d({},e),{autoIntervalMs:Math.round(6e4*i)}),E.setSettings(e)):"qs-max-autos"===a.id?(i=a,e=E.getSettings(),i=parseInt(i.value,10),i=Number.isFinite(i)&&0<i?i:e.maxAutosnapshots,e=c(d({},e),{maxAutosnapshots:i}),E.setSettings(e),i=e,t=(e=x()).filter(e=>"manual"===e.type),e=e.filter(e=>"auto"===e.type).slice(0,i.maxAutosnapshots),j([...t,...e]),O()):"qs-queue-warn-enabled"===a.id?(i=!!a.checked,t=E.getSettings(),e=c(d({},t),{queueWarnEnabled:i}),E.setSettings(e),n()):"qs-queue-max-size"===a.id?(i=a,e=E.getSettings(),i=parseInt(i.value,10),i=Number.isFinite(i)&&1<i?i:null!=(i=e.queueMaxSize)?i:80,e=c(d({},e),{queueMaxSize:i}),E.setSettings(e)):"qs-queue-warn-threshold"===a.id&&(i=a,e=E.getSettings(),a=parseInt(i.value,10),a=Number.isFinite(a)&&0<=a?a:null!=(i=e.queueWarnThreshold)?i:5,i=c(d({},e),{queueWarnThreshold:a}),E.setSettings(i)))},document.addEventListener("click",m,!0),document.addEventListener("change",h,!0),n()}function O(){var e,t=document.getElementById("qs-list");t&&(e=Q(),t.innerHTML=e||'<div style="opacity:0.7">No snapshots yet</div>')}function _(){let a=[],t=null,s=[],o=null,r=null;function l(){null!==t&&(clearInterval(t),t=null)}async function d(e){try{if(e.autoEnabled){var i=await T();if(i.length){if(e.onlyNewItems){let t=new Set(a);if(!i.some(e=>!t.has(e)))return void(a=i)}((t,i)=>{if(t.length===i.length){for(let e=0;e<t.length;e++)if(t[e]!==i[e])return;return 1}})(i,a)||(D({id:R(),createdAt:Date.now(),type:"auto",items:i},e),a=i)}else console.log(A+": queue is empty, skipping auto snapshot")}}catch(e){console.error(A+": auto snapshot error",e),Spicetify.showNotification(A+": failed to save an automatic snapshot")}}function c(e){l(),e.autoEnabled&&(t=window.setInterval(()=>d(e),e.autoIntervalMs),r=e.autoIntervalMs)}function u(){for(var e of s)e();s=[]}return{startAutoTimer:c,primeFromExisting:function(){var e,t=x()[0];null!=(e=null==t?void 0:t.items)&&e.length&&(a=t.items.slice())},applyAutoMode:function(e){var t=e.autoEnabled?e.autoMode:null;if(t===o)"timer"===t&&r!==e.autoIntervalMs&&c(e);else{if("on-change"===o?u():"timer"===o&&l(),"on-change"===t){var i,a,n=e;if(u(),n.autoEnabled)try{let e=null==(a=null==(i=null==Spicetify?void 0:Spicetify.Player)?void 0:i.origin)?void 0:a._events;if(null==e||!e.addListener||null==e||!e.removeListener)throw new Error("queue_update events API not available");let t=e=>{d(n),console.log(A+": queue_update",e)};e.addListener("queue_update",t),s.push(()=>{try{e.removeListener("queue_update",t)}catch(e){console.error(A+": failed to remove queue_update listener",e)}})}catch(e){console.error(A+": failed to start queue update watcher",e),Spicetify.showNotification(A+": failed to start queue update watcher")}}else"timer"===t?c(e):(u(),l());o=t}}}}function B(d){let n=null,c=null,u=0,p=3e4;async function s(){var e,t;try{var i,a,n,s,o,r,l=d();l.queueWarnEnabled&&(i=null!=(e=l.queueMaxSize)?e:80,(a=null!=(t=l.queueWarnThreshold)?t:5)<0||i<=1||(n=await T()).length&&(s=Math.max(0,i-n.length))<=a&&(o=Date.now(),c!==s||o-u>=p)&&(r=i-s,Spicetify.showNotification(A+`: Queue nearly full (${r}/${i})`,!1,2500),c=s,u=o))}catch(e){console.warn(A+": queue capacity check failed",e)}}function e(){if(n){try{n()}catch(e){}n=null}}return{start:function(){var i,a;e();try{let e=null==(a=null==(i=null==Spicetify?void 0:Spicetify.Player)?void 0:i.origin)?void 0:a._events;if(null==e||!e.addListener||null==e||!e.removeListener)throw new Error("queue_update events API not available");let t=e=>{s()};e.addListener("queue_update",t),n=()=>{try{e.removeListener("queue_update",t)}catch(e){console.error(A+": failed to remove queue_update listener (capacity watcher)",e)}},s()}catch(e){console.error(A+": failed to start capacity watcher",e),Spicetify.showNotification(A+": failed to start capacity watcher")}},stop:e,checkAndWarnOnce:s}}a=Object.defineProperty,i=Object.defineProperties,n=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,l=(e,t,i)=>t in e?a(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,d=(e,t)=>{for(var i in t=t||{})o.call(t,i)&&l(e,i,t[i]);if(s)for(var i of s(t))r.call(t,i)&&l(e,i,t[i]);return e},c=(e,t)=>i(e,n(t)),p={autoEnabled:!(u="queue-manager:settings"),autoIntervalMs:3e5,maxAutosnapshots:20,autoMode:"timer",onlyNewItems:!0,queueWarnEnabled:!0,queueMaxSize:80,queueWarnThreshold:5},f="queue-manager:snapshots",A="Queue Manager",g="0.2",y="beta",N=new Map,h=m=null,M=new Set,v=16,e=async function(){for(var e;null==Spicetify||!Spicetify.showNotification||null==Spicetify||!Spicetify.CosmosAsync||null==Spicetify||!Spicetify.LocalStorage;)await new Promise(e=>setTimeout(e,100));let t=q(),i=_(),a=(i.primeFromExisting(),i.applyAutoMode(t),B(()=>t)),n=(a.start(),{getSettings:()=>t,setSettings:e=>{t=e,Spicetify.LocalStorage.set(u,JSON.stringify(e)),i.applyAutoMode(e),a.checkAndWarnOnce()}});try{null!=(e=null==Spicetify?void 0:Spicetify.Topbar)&&e.Button&&new Spicetify.Topbar.Button(A,"queue",()=>k(n),void 0,!0)}catch(e){console.error(A+": failed to add topbar button")}try{new Spicetify.ContextMenu.Item(A,()=>k(n),(e,t,i)=>{var a,n,s;try{if(i){var o=Spicetify.URI.fromString(i);if((null==o?void 0:o.type)===Spicetify.URI.Type.QUEUE)return!0;if(i.includes(":queue"))return!0}return((null==(s=null==(n=null==(a=Spicetify.Platform)?void 0:a.History)?void 0:n.location)?void 0:s.pathname)||"").includes("queue")}catch(e){}return!1},"queue").register()}catch(e){console.error(A+": failed to add context menu item")}try{Spicetify.Keyboard.registerShortcut({key:"q",ctrl:!0,alt:!0},()=>k(n))}catch(e){console.error(A+": failed to add keyboard shortcut")}},(async()=>{await e()})(),(async()=>{var e;document.getElementById("queueDmanager")||((e=document.createElement("style")).id="queueDmanager",e.textContent=String.raw`
  .qs-container{display:flex;flex-direction:column;gap:18px;overflow:visible}.qs-header{display:flex;justify-content:space-between;align-items:center;padding:16px;border-radius:12px;background:linear-gradient(135deg,rgba(52,211,153,.16),rgba(37,99,235,.12));border:1px solid rgba(255,255,255,.06);gap:12px}.qs-header-title{display:flex;align-items:center;gap:12px;font-weight:600}.qs-header-text{display:flex;flex-direction:column;gap:4px}.qs-header-app{display:flex;align-items:center;gap:10px}.qs-header-badges{display:inline-flex;gap:6px;align-items:center}.qs-header-icon{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:50%;background:rgba(0,0,0,.4)}.qs-header-name{font-size:18px}.qs-header-sub,.qs-header-sub-alt{font-size:13px;opacity:.75}.qs-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}.qs-settings{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:18px;padding:16px;border-radius:12px;background:var(--spice-section-bg,rgba(255,255,255,.05));border:1px solid rgba(255,255,255,.05);overflow:visible}.qs-settings-header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px}.qs-right{display:flex;flex-direction:column;gap:16px}.qs-setting{display:flex;flex-direction:column;gap:6px}.qs-setting label{font-weight:600;display:inline-flex;align-items:center;gap:8px}.qs-dim{color:rgba(255,255,255,.7);font-size:12px}.qs-row{display:flex;flex-direction:column;gap:12px;padding:12px 16px;border-radius:10px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.04);box-shadow:0 10px 30px rgba(0,0,0,.25)}.qs-row+.qs-row{margin-top:12px}.qs-row-main{display:flex;flex-direction:column;gap:10px}.qs-row-title{font-weight:600;display:inline-flex;align-items:center;gap:8px}.qs-title-actions{display:inline-flex;align-items:center;gap:6px;margin-left:8px}.qs-icon-btn{display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:0 0;border:1px solid transparent;cursor:pointer;padding:0;transition:background .15s ease,transform .12s ease,border .12s ease;color:inherit}.qs-icon-btn:hover{background:linear-gradient(135deg,rgba(96,165,250,.35),rgba(59,130,246,.2));border-color:rgba(96,165,250,.4);transform:translateY(-1px)}.qs-icon-btn:focus-visible{outline:2px solid rgba(96,165,250,.8);outline-offset:2px}.qs-icon-btn .qs-svg-icon{width:16px;height:16px}.qs-row-meta{display:flex;flex-wrap:wrap;gap:6px;font-size:12px;align-items:center}.qs-row-actions{display:flex;flex-wrap:nowrap;gap:10px;padding:2px 0;overflow-x:auto}.qs-row-actions .qs-btn{flex:0 0 auto;justify-content:flex-start}.qs-btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:6px 10px;border-radius:8px;background:rgba(255,255,255,.08);color:inherit;border:1px solid transparent;cursor:pointer;font-weight:600;transition:transform .12s ease,box-shadow .12s ease,border .12s ease;text-decoration:none}.qs-btn.primary{background:linear-gradient(135deg,rgba(96,165,250,.9),rgba(59,130,246,.9));border-color:rgba(96,165,250,.35)}.qs-btn.subtle{background:rgba(255,255,255,.04);border-color:rgba(255,255,255,.08)}.qs-btn.danger{background:rgba(248,113,113,.16);border-color:rgba(248,113,113,.25)}.qs-btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(0,0,0,.25)}.qs-btn:focus-visible{outline:2px solid rgba(96,165,250,.8);outline-offset:2px}.qs-btn-icon{display:inline-flex;align-items:center;justify-content:center}.qs-btn-label{white-space:nowrap}.qs-svg-icon{display:block;fill:currentColor;width:16px;height:16px}.qs-section-card{display:flex;flex-direction:column;gap:12px;padding:16px;border-radius:12px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.05)}.qs-section-head{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:center}.qs-section-heading{display:inline-flex;align-items:center;gap:12px;font-weight:600}.qs-section-text{display:flex;flex-direction:column;gap:2px}.qs-section-name{font-size:16px}.qs-section-caption{font-size:12px;opacity:.75}.qs-section-body{display:flex;flex-direction:column}.qs-empty{opacity:.6;font-size:13px;padding:12px}.qs-input{padding:8px 10px;border-radius:8px;background:rgba(0,0,0,.25);color:inherit;border:1px solid rgba(255,255,255,.1);font-size:14px}.qs-input:disabled{opacity:.6;cursor:not-allowed}.qs-checkbox{display:inline-flex;align-items:center;gap:10px}.qs-radio-group{display:inline-flex;gap:12px;align-items:center;margin-top:6px}.qs-radio-label span{display:inline-flex;align-items:center;gap:6px}.qs-icon{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;font-size:12px;line-height:16px;margin-left:2px;position:relative}.qs-icon-glyph{opacity:.7;transition:opacity .12s ease-in-out}.qs-icon:hover .qs-icon-glyph{opacity:1}.qs-icon>.qs-tooltip{position:absolute;left:50%;transform:translateX(-50%);bottom:calc(100% + 6px);white-space:nowrap;text-align:left;padding:8px 10px;border-radius:4px;font-size:12px;background:#121212;border:1px solid rgba(255,255,255,.08);box-shadow:0 4px 14px rgba(0,0,0,.35);color:var(--spice-text,#fff);pointer-events:none;opacity:0;transition:opacity .12s ease-in-out;z-index:9999}.qs-icon:hover>.qs-tooltip{opacity:1}.qs-tooltip .qs-tooltip-emph{color:#ff4e4e}.qs-radio:disabled{cursor:not-allowed}.qs-radio:disabled+span{opacity:.6;cursor:not-allowed}.qs-items{margin:10px 0 14px 0;padding:12px;border-left:2px solid rgba(59,130,246,.35);background:rgba(59,130,246,.12);border-radius:8px}.qs-items-body{display:flex;flex-direction:column;gap:4px;font-size:13px;max-height:240px;overflow:auto}.qs-pill{display:inline-flex;align-items:center;justify-content:center;padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.12);font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px}.qs-pill--accent{background:linear-gradient(135deg,rgba(59,130,246,.85),rgba(99,102,241,.85))}.qs-pill--version{background:rgba(255,255,255,.12)}.qs-pill--channel{background:rgba(248,113,113,.35)}@media (max-width:860px){.qs-header{flex-direction:column;align-items:flex-start}.qs-actions{width:100%;justify-content:flex-start}.qs-row{grid-template-columns:1fr}.qs-row-actions{grid-template-columns:repeat(auto-fit,minmax(120px,1fr))}}
      `.trim(),document.head.appendChild(e))})()})();