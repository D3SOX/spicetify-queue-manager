(async()=>{for(;!Spicetify.React||!Spicetify.ReactDOM;)await new Promise(e=>setTimeout(e,10));var i,a,n,s,o,r,l,c,d,u,p,f,S,m,y,k,q,g,v,E,$,W,e;function R(){var e;try{var t,a=Spicetify.LocalStorage.get(u);return a?{autoEnabled:null!=(e=(t=JSON.parse(a)).autoEnabled)?e:p.autoEnabled,autoIntervalMs:("number"==typeof t.autoIntervalMs&&0<t.autoIntervalMs?t:p).autoIntervalMs,maxAutosnapshots:("number"==typeof t.maxAutosnapshots&&0<t.maxAutosnapshots?t:p).maxAutosnapshots,autoMode:"timer"===t.autoMode?"timer":"on-change",onlyNewItems:!1!==t.onlyNewItems,queueWarnEnabled:!1!==t.queueWarnEnabled,queueMaxSize:("number"==typeof t.queueMaxSize&&1<t.queueMaxSize?t:p).queueMaxSize,queueWarnThreshold:("number"==typeof t.queueWarnThreshold&&0<=t.queueWarnThreshold?t:p).queueWarnThreshold,promptManualBeforeReplace:!1!==t.promptManualBeforeReplace}:p}catch(e){return p}}function N(){try{var e,t=Spicetify.LocalStorage.get(f);return t?(e=JSON.parse(t),Array.isArray(e)?e:[]):[]}catch(e){return[]}}function t(e){return e.sort((e,t)=>t.createdAt-e.createdAt)}function A(e){t(e),Spicetify.LocalStorage.set(f,JSON.stringify(e))}function h(){return t(N())}function O(e,t){var t=null!=t?t:R(),a=N(),i=a.filter(e=>"manual"===e.type),a=a.filter(e=>"auto"===e.type);"auto"===e.type?(t=[e,...a].slice(0,t.maxAutosnapshots),A([...i,...t])):A([e,...i,...a])}function L(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function M(e,t){var a=e.querySelector(".qs-btn-label");a?a.textContent=t:e.textContent=t}function B(){return Date.now()+"-"+Math.random().toString(36).slice(2,8)}async function C(e,t){try{var a=JSON.stringify(t,null,2),i=new Blob([a],{type:"application/json"}),n=window;if(n&&"function"==typeof n.showSaveFilePicker)try{var s=await(await n.showSaveFilePicker({suggestedName:e,types:[{description:"JSON Files",accept:{"application/json":[".json"]}}]})).createWritable();return await s.write(i),void await s.close()}catch(e){if(e&&("AbortError"===e.name||"NotAllowedError"===e.name))return void Spicetify.showNotification(S+": Export canceled")}var o=URL.createObjectURL(i),r=document.createElement("a");r.href=o,r.download=e,document.body.appendChild(r),r.click(),r.remove(),URL.revokeObjectURL(o),Spicetify.showNotification(S+`: Exported ${e} to Downloads folder`)}catch(e){console.warn(S+": downloadJson failed",e),Spicetify.showNotification(S+": Failed to export JSON")}}async function F(t){let a,n=new Array(t.length).fill(""),s=[],o=[];t.forEach((e,t)=>{var a,i;e.startsWith("spotify:local:")?n[t]=(t=>{var a=(t=t.split(":"))[2]||"Local",t=t[4]||"track";try{return decodeURIComponent(a.replace(/\+/g," "))+" - "+decodeURIComponent(t.replace(/\+/g," "))}catch(e){return a+" - "+t}})(e):({type:a,id:i}=(e=>{if(3<=(e=e.split(":")).length){if("track"===e[1])return{type:"track",id:e[2]};if("episode"===e[1])return{type:"episode",id:e[2]}}return{type:null,id:null}})(e),"track"===a&&i?s.push({idx:t,id:i}):"episode"===a&&i?o.push({idx:t,id:i}):n[t]=e)});for(let e=0;e<s.length;e+=50){var i=s.slice(e,e+50),r=i.map(e=>e.id).join(",");try{var l,c,d,u,p=await Spicetify.CosmosAsync.get("https://api.spotify.com/v1/tracks?ids="+r),f=Array.isArray(null==p?void 0:p.tracks)?p.tracks:[],m=new Map;for(l of f)null!=l&&l.id&&null!=l&&l.name&&(d=(c=Array.isArray(null==l?void 0:l.artists)?l.artists.map(e=>null==e?void 0:e.name).filter(Boolean).join(", "):"")?c+" - "+l.name:l.name,m.set(l.id,d));for(u of i)n[u.idx]=m.get(u.id)||t[u.idx]}catch(e){for(var y of i)n[y.idx]=t[y.idx]}}if(o.length)for(let e=0;e<o.length;e+=50){var g=o.slice(e,e+50),v=g.map(e=>e.id).join(",");try{var h,b,x,q,w=await Spicetify.CosmosAsync.get("https://api.spotify.com/v1/episodes?ids="+v),S=Array.isArray(null==w?void 0:w.episodes)?w.episodes:[],k=new Map;for(h of S)null!=h&&h.id&&null!=h&&h.name&&(x=(b=null==(a=null==h?void 0:h.show)?void 0:a.name)?b+" - "+h.name:h.name,k.set(h.id,x));for(q of g)n[q.idx]=k.get(q.id)||t[q.idx]}catch(e){for(var E of g)n[E.idx]=t[E.idx]}}return n}function I(e){return("auto"===e.type?"Auto":"Manual")+" "+(t=>{try{return new Date(t).toLocaleString()}catch(e){return""+t}})(e.createdAt)}function U(e){return e.name||I(e)}function b(e){return"string"==typeof e&&e.startsWith("spotify:")?e:e&&"string"==typeof e.uri&&e.uri.startsWith("spotify:")?e.uri:e&&e.contextTrack&&"string"==typeof e.contextTrack.uri&&e.contextTrack.uri.startsWith("spotify:")?e.contextTrack.uri:e&&e.track&&"string"==typeof e.track.uri&&e.track.uri.startsWith("spotify:")?e.track.uri:e&&e.item&&"string"==typeof e.item.uri&&e.item.uri.startsWith("spotify:")?e.item.uri:null}function x(){var t,a,i;try{var n,s=Spicetify.Queue,o=[],r=b(null==s?void 0:s.track)||b(null==(a=null==(t=Spicetify.Player)?void 0:t.data)?void 0:a.item),l=(r&&o.push(r),(null==s?void 0:s.nextTracks)||[]);let e=0;for(n of Array.isArray(l)?l:[]){var c,d=null==n?void 0:n.provider,u=(null==(i=null==n?void 0:n.contextTrack)?void 0:i.metadata)||(null==n?void 0:n.metadata),p=!0===(null==u?void 0:u.is_queued)||"true"===(null==u?void 0:u.is_queued);("queue"===d||p)&&(c=b(n))&&(o.push(c),e++)}var f=o.length?(e=>{var t,a=[];let i=null;for(t of e)t&&t!==i&&a.push(t),i=t;return a})(o):[];return console.log(S+": Spicetify.Queue -> now=%s queuedNext=%d total=%d",Boolean(r),e,f.length),f}catch(e){return console.error(S+": Spicetify.Queue read failed",e),[]}}function Q(e){return"danger"===e?"danger":"primary"===e?"primary":"subtle"===e?"subtle":"default"}function _(){var e=document.createElement("div");return e.className="qs-confirm-backdrop",document.body.appendChild(e),e}function J(e){var t=document.createElement("div");return t.className="qs-confirm-dialog",e.appendChild(t),t}function H(e){if(q)return Promise.resolve(!1);q=!0;let{title:p,message:f,confirmLabel:m="Confirm",cancelLabel:y="Cancel",tone:g}=e;return new Promise(t=>{let a=_();var e=J(a),i=(p&&((i=document.createElement("div")).className="qs-confirm-title",i.textContent=p,e.appendChild(i)),document.createElement("div")),i=(i.className="qs-confirm-message",i.textContent=f,e.appendChild(i),document.createElement("div")),n=(i.className="qs-confirm-actions",document.createElement("button"));n.type="button",n.className="qs-btn subtle",n.textContent=y;let s=document.createElement("button");s.type="button";var o=Q(g),r=["qs-btn"];r.push("default"!==o?o:"primary"),s.className=r.join(" "),s.textContent=m,i.append(n,s),e.appendChild(i);let l=document.activeElement,c=!1;function d(e){c||(c=!0,a.remove(),null!=l&&l.focus&&l.focus(),document.removeEventListener("keydown",u,!0),q=!1,t(e))}function u(e){"Escape"===e.key?(e.preventDefault(),d(!1)):"Enter"===e.key&&document.activeElement===s&&(e.preventDefault(),d(!0))}n.addEventListener("click",()=>d(!1)),s.addEventListener("click",()=>d(!0)),a.addEventListener("click",e=>{e.target===a&&d(!1)}),document.addEventListener("keydown",u,!0),setTimeout(()=>{s.focus()},0)})}async function V(){var e,t;try{var a,i=await x();i.length?null!==(a=null!=(t=null==(e=await(e=>{if(q)return Promise.resolve(null);q=!0;let{title:m,message:y,confirmLabel:g="Confirm",cancelLabel:v="Cancel",tone:h,defaultValue:b="",placeholder:x}=e;return new Promise(t=>{let a=_();var e=J(a);m&&((n=document.createElement("div")).className="qs-confirm-title",n.textContent=m,e.appendChild(n)),y&&((n=document.createElement("div")).className="qs-confirm-message",n.textContent=y,e.appendChild(n));let i=document.createElement("input");i.type="text",i.className="qs-dialog-input",i.value=b,x&&(i.placeholder=x),e.appendChild(i);var n=document.createElement("div"),s=(n.className="qs-confirm-actions",document.createElement("button")),o=(s.type="button",s.className="qs-btn subtle",s.textContent=v,document.createElement("button")),r=(o.type="button",Q(h)),l=["qs-btn"];l.push("default"!==r?r:"primary"),o.className=l.join(" "),o.textContent=g,n.append(s,o),e.appendChild(n);let c=document.activeElement,d=!1;function u(e){d||(d=!0,a.remove(),i.removeEventListener("keydown",p),document.removeEventListener("keydown",f,!0),null!=c&&c.focus&&c.focus(),q=!1,t(e))}function p(e){"Enter"===e.key?(e.preventDefault(),u(i.value)):"Escape"===e.key&&(e.preventDefault(),u(null))}function f(e){"Escape"===e.key&&(e.preventDefault(),u(null))}s.addEventListener("click",()=>u(null)),o.addEventListener("click",()=>u(i.value)),i.addEventListener("keydown",p),document.addEventListener("keydown",f,!0),a.addEventListener("click",e=>{e.target===a&&u(null)}),setTimeout(()=>{i.focus(),i.select()},0)})})({title:"Save snapshot",message:"Name this snapshot",confirmLabel:"Save",cancelLabel:"Cancel",defaultValue:I({type:"manual",createdAt:Date.now()})}))?void 0:e.trim())?t:null)&&(""===a?Spicetify.showNotification(S+": Snapshot not saved (name cannot be empty)"):(O({id:B(),createdAt:Date.now(),name:a,type:"manual",items:i}),Spicetify.showNotification(S+": Snapshot saved"))):Spicetify.showNotification(S+": No queue found. If you believe this is an error, please try to play and pause a track.")}catch(e){console.error(S+": manual snapshot failed",e),Spicetify.showNotification(S+": Failed to save snapshot")}}function j(t){Array.from($.keys()).forEach(e=>{e!==t&&K(e)})}function K(e){var t=$.get(e);t&&(t.input.removeEventListener("keydown",t.onKeyDown),t.input.removeEventListener("blur",t.onBlur),t.input.isConnected&&t.input.remove(),t.labelEl.style.display="",t.labelEl.textContent=t.originalLabel,t.actionsEl&&(t.actionsEl.style.display=null!=(t=t.originalActionsDisplay)?t:""),$.delete(e))}function P(e,t=W){var a=(null!=(a=Spicetify.SVGIcons)?a:{})[e];return a?`<span class="qs-btn-icon" data-icon-name="${L(e)}"><svg class="qs-svg-icon" viewBox="0 0 16 16" aria-hidden="true" focusable="false" style="width:${t}px;height:${t}px;">${a}</svg></span>`:""}function z(e,t,a={}){var{action:a,id:i,tone:n="default",title:s}=a,o=["qs-btn"],n=("danger"===n&&o.push("danger"),"primary"===n&&o.push("primary"),"subtle"===n&&o.push("subtle"),[]),a=(a&&n.push(`data-action="${a}"`),i&&n.push(`id="${i}"`),s&&n.push(`title="${L(s)}"`),n.length?" "+n.join(" "):""),i=P(t);return`<button type="button" class="${o.join(" ")}"${a}>${i}<span class="qs-btn-label">${L(e)}</span></button>`}function Y(e,t,a){return`<button type="button" class="qs-icon-btn" data-action="${L(e)}" title="${L(a)}">${P(t)}</button>`}function D(e,t="default"){var a=["qs-pill"];return"default"!==t&&a.push({accent:"qs-pill--accent",version:"qs-pill--version",channel:"qs-pill--channel"}[t]),`<span class="${a.join(" ")}">${L(e)}</span>`}function G(e){return e.map(e=>{var t=L(U(e)),a=e.items.some(e=>e.startsWith("spotify:local:")),i=[D(e.items.length+" "+(1===e.items.length?"item":"items"),"accent")],a=(a&&i.push(D("includes local")),i.join(""));return`
          <div class="qs-row" data-id="${e.id}">
            <div class="qs-row-main">
              <div class="qs-row-title">
                ${P("auto"===e.type?"clock":"playlist")}
                <span>${t}</span>
                <span class="qs-title-actions">
                  ${Y("rename","edit","Rename snapshot")}
                  ${e.name?Y("reset-name","repeat","Reset name"):""}
                </span>
              </div>
              <div class="qs-row-meta">${a}</div>
              <div class="qs-row-actions">
                ${z("View items","list-view",{action:"toggle-items",title:"Toggle items"})}
                ${z("Replace queue","queue",{action:"replace-queue",title:"Replace queue",tone:"primary"})}
                ${z("Export","download",{action:"export",title:"Export to playlist"})}
                ${z("Delete","minus",{action:"delete",title:"Delete snapshot",tone:"danger"})}
              </div>
            </div>
          </div>
          <div class="qs-items" data-id="${e.id}" style="display:none">
            <div class="qs-items-body">Loading…</div>
          </div>
        `}).join("")}function X(){var e=h(),t=e.filter(e=>"auto"===e.type),e=e.filter(e=>"manual"===e.type),a=G(t),i=G(e);return`
      <div class="qs-section-card">
        <div class="qs-section-head">
          <div class="qs-section-heading">
            ${P("playlist")}
            <div class="qs-section-text">
              <div class="qs-section-name">Manual Snapshots</div>
              <div class="qs-section-caption">Your saved queues for later</div>
            </div>
            ${D(String(e.length),"accent")}
          </div>
          <div class="qs-actions">
            ${z("Export all","download",{id:"qs-export-manuals",tone:"subtle"})}
            ${z("Save now","plus-alt",{id:"qs-new-manual",tone:"primary"})}
          </div>
        </div>
        <div class="qs-section-body">
          ${i||'<div class="qs-empty">No manual snapshots yet</div>'}
        </div>
      </div>
      <div class="qs-section-card">
        <div class="qs-section-head">
          <div class="qs-section-heading">
            ${P("clock")}
            <div class="qs-section-text">
              <div class="qs-section-name">Automatic Snapshots</div>
              <div class="qs-section-caption">Captured in the background</div>
            </div>
            ${D(String(t.length),"accent")}
          </div>
          <div class="qs-actions">
            ${z("Export all","download",{id:"qs-export-autos",tone:"subtle"})}
          </div>
        </div>
        <div class="qs-section-body">
          ${a||'<div class="qs-empty">No automatic snapshots yet</div>'}
        </div>
      </div>
    `}function w(w){var e=D("v"+m,"version"),t=y?D(y.toUpperCase(),"channel"):"",a=X(),i=w.getSettings(),e=`
      <div class="qs-container">
        <div class="qs-header">
          <div class="qs-header-title">
            <div class="qs-header-icon">${P("queue",20)}</div>
            <span class="qs-header-badges">${e}${t}</span>
          </div>
          <div class="qs-actions">
            ${z("Refresh","repeat",{id:"qs-refresh",tone:"subtle"})}
            ${z("Export settings","download",{id:"qs-export-settings"})}
          </div>
        </div>
        <div class="qs-settings">
          <div class="qs-settings-header">
            <div class="qs-section-heading">
              ${P("grid-view")}
              <div class="qs-section-text">
                <div class="qs-section-name">Settings</div>
                <div class="qs-section-caption">Tune automation and queue alerts</div>
              </div>
            </div>
          </div>
          <div class="qs-setting">
              <label class="qs-checkbox"><input type="checkbox" id="qs-auto-enabled" ${i.autoEnabled?"checked":""}/> ${P("brightness")}Enable automatic snapshots</label>
            <div class="qs-dim">Mode 
              <div class="qs-radio-group" id="qs-auto-mode-group">
                <label class="qs-radio-label"><input type="radio" class="qs-radio" name="qs-auto-mode" value="timer" ${"timer"===i.autoMode?"checked":""} ${i.autoEnabled?"":"disabled"}/><span>${P("clock")} Time-based</span></label>
                <label class="qs-radio-label"><input type="radio" class="qs-radio" name="qs-auto-mode" value="on-change" ${"on-change"===i.autoMode?"checked":""} ${i.autoEnabled?"":"disabled"}/><span>${P("shuffle")} Queue changes</span><span class="qs-icon"><span class="qs-icon-glyph">ⓘ</span><span class="qs-tooltip"><span class="qs-tooltip-emph">Experimental!</span>This mode may create many similar snapshots (for example when queuing a bunch of songs)</span></span></label>
              </div>
            </div>
            <div class="qs-setting" style="margin-top:6px">
              <label class="qs-checkbox"><input type="checkbox" id="qs-only-new" ${i.onlyNewItems?"checked":""} ${i.autoEnabled?"":"disabled"}/> ${P("search")} Check for new items</label>
              <div style="opacity:0.7; font-size:12px">Only trigger it when there is a new song that was not in the previous snapshot.</div>
            </div>
            <div class="qs-setting" style="margin-top:6px">
              <div style="opacity:0.7; font-size:12px">Equal queues are never saved as automatic snapshots.</div>
            </div>
            <div class="qs-setting" style="margin-top:12px">
              <label class="qs-checkbox"><input type="checkbox" id="qs-queue-warn-enabled" ${i.queueWarnEnabled?"checked":""}/> ${P("exclamation-circle")} Warn when queue is nearly full</label>
              <div style="opacity:0.7; font-size:12px">Heuristic limit; includes current track. Adjust if needed.</div>
            </div>
            <div class="qs-setting" style="margin-top:12px">
              <label class="qs-checkbox"><input type="checkbox" id="qs-prompt-manual-before-replace" ${i.promptManualBeforeReplace?"checked":""}/> ${P("copy")} Ask to save manual snapshot before replacing queue</label>
              <div style="opacity:0.7; font-size:12px">Offers to store the current queue before overwriting it.</div>
            </div>
          </div>
          <div class="qs-right">
            <div class="qs-setting">
              <label>${P("clock")} Interval (minutes)</label>
              <input class="qs-input" type="number" id="qs-auto-interval-mins" min="0.5" step="0.5" value="${(i.autoIntervalMs/6e4).toFixed(2)}" ${i.autoEnabled&&"timer"===i.autoMode?"":"disabled"} />
              <div style="opacity:0.7; font-size:12px">Minimum 0.5 (30 seconds)</div>
            </div>
            <div class="qs-setting">
              <label>${P("chart-up")} Max automatic snapshots</label>
              <input class="qs-input" type="number" id="qs-max-autos" min="1" step="1" value="${i.maxAutosnapshots}" ${i.autoEnabled?"":"disabled"} />
              <div style="opacity:0.7; font-size:12px">Older snapshots are pruned. Be careful when changing this</div>
            </div>
            <div class="qs-setting">
              <label>${P("queue")} Queue max size</label>
              <input class="qs-input" type="number" id="qs-queue-max-size" min="10" step="1" value="${i.queueMaxSize}" ${i.queueWarnEnabled?"":"disabled"} />
            </div>
            <div class="qs-setting">
              <label>${P("exclamation-circle")} Warn when remaining slots ≤</label>
              <input class="qs-input" type="number" id="qs-queue-warn-threshold" min="0" step="1" value="${i.queueWarnThreshold}" ${i.queueWarnEnabled?"":"disabled"} />
            </div>
          </div>
        </div>
        <div id="qs-list">
          ${a||'<div style="opacity:0.7">No snapshots yet</div>'}
        </div>
      </div>
    `;function n(){let t=w.getSettings();var e=document.querySelectorAll('input.qs-radio[name="qs-auto-mode"]'),a=document.querySelector("#qs-auto-interval-mins"),i=document.querySelector("#qs-only-new"),n=document.querySelector("#qs-max-autos"),s=document.querySelector("#qs-queue-max-size"),o=document.querySelector("#qs-queue-warn-threshold"),e=(e.forEach(e=>{e.disabled=!t.autoEnabled}),a&&(a.disabled=!(t.autoEnabled&&"timer"===t.autoMode)),i&&(i.disabled=!t.autoEnabled),n&&(n.disabled=!t.autoEnabled),t.queueWarnEnabled);s&&(s.disabled=!e),o&&(o.disabled=!e)}Spicetify.PopupModal.display({title:S,content:e,isLarge:!0}),g&&(document.removeEventListener("click",g,!0),g=null),v&&(document.removeEventListener("change",v,!0),v=null),g=async function(e){var a=document.querySelector(".qs-container"),i=e.target;if(a&&i&&a.contains(i)&&e.stopPropagation(),a&&i){a=i.closest(".qs-btn, .qs-icon-btn");if("qs-new-manual"===(null==a?void 0:a.id))e.preventDefault(),j(),await V(),T();else{if("qs-export-settings"===(null==a?void 0:a.id))return e.preventDefault(),i=w.getSettings(),C(S+"-settings.json",i);if("qs-export-manuals"===(null==a?void 0:a.id))return e.preventDefault(),i=N().filter(e=>"manual"===e.type),C(S+"-manual-snapshots.json",i);if("qs-export-autos"===(null==a?void 0:a.id))return e.preventDefault(),i=N().filter(e=>"auto"===e.type),C(S+"-auto-snapshots.json",i);if("qs-refresh"===(null==a?void 0:a.id))e.preventDefault(),T();else if(a){var i=a.closest(".qs-row"),n=a.getAttribute("data-action"),s=a.classList.contains("qs-icon-btn");if(i&&(n||!s)){let t=i.getAttribute("data-id");if(t){$.has(t)||j(t);var o=N().find(e=>e.id===t);if(o){if(s)return"rename"===n?(e.preventDefault(),void function n(s,o){if(s.isConnected){let i=o.id;if($.has(i))(a=$.get(i))&&(a.input.focus(),a.input.select());else{var a=s.querySelector(".qs-row-title");if(a){var r=Array.from(a.querySelectorAll("span"))[1];if(r){var l=null!=(l=a.querySelector(".qs-title-actions"))?l:void 0,c=null!=(c=r.textContent)?c:"",d=I(o),u=null!=(u=null==l?void 0:l.style.display)?u:"";let e=document.createElement("input"),t=(e.type="text",e.value=null!=(p=o.name)?p:c,e.className="qs-inline-input",e.setAttribute("aria-label","Snapshot name"),r.style.display="none",l&&(l.style.display="none"),a.insertBefore(e,null!=l?l:null),e=>{var t,a=$.get(i);a&&(K(i),e)&&((e=a.input.value.trim())?e!==a.originalLabel.trim()&&(e===a.generatedName?Spicetify.showNotification("Name must differ from the default suggestion",!0,2e3):0<=(t=(a=N()).findIndex(e=>e.id===i))&&(a[t].name=e,A(a),T())):(Spicetify.showNotification("Name cannot be empty",!0,2e3),n(s,o)))});var p={input:e,labelEl:r,originalLabel:c,actionsEl:l,originalActionsDisplay:u,generatedName:d,onKeyDown(e){"Enter"===e.key?(e.preventDefault(),t(!0)):"Escape"===e.key&&(e.preventDefault(),t(!1))},onBlur(){t(!0)}};$.set(i,p),e.addEventListener("keydown",p.onKeyDown),e.addEventListener("blur",p.onBlur),setTimeout(()=>{e.focus(),e.select()},0)}}}}}(i,o)):"reset-name"===n?(e.preventDefault(),void(0<=(e=(s=N()).findIndex(e=>e.id===t))&&(delete s[e].name,A(s),T()))):void 0;var r,e=n;if(e)if("toggle-items"===e){s=i.nextElementSibling,n=a;if(s&&s.classList.contains("qs-items"))if("none"===s.style.display||!s.style.display){s.style.display="block",M(n,"Hide items");i=s.querySelector(".qs-items-body");if(i){i.textContent="Loading…";try{d=o;var l=await(k.has(d.id)?k.get(d.id):(r=await F(d.items),k.set(d.id,r),r));i.innerHTML=l.map((e,t)=>`<div>${t+1}. ${L(e)}</div>`).join("")}catch(e){i.textContent="Failed to load items"}}}else s.style.display="none",M(n,"View items")}else if("export"===e){if(!E.has(t)){E.add(t);var c=o,d=a;try{if(c.items.length){d&&(d.disabled=!0,M(d,"Exporting…"));var u=await Spicetify.CosmosAsync.get("https://api.spotify.com/v1/me"),p=null==u?void 0:u.id;if(!p)throw new Error("No user id");var f=U(c),m=await Spicetify.CosmosAsync.post(`https://api.spotify.com/v1/users/${encodeURIComponent(p)}/playlists`,{name:f,description:`Saved from ${S} on `+new Date(c.createdAt).toLocaleString(),public:!1}),y=null==m?void 0:m.id;if(!y)throw new Error("Playlist creation failed");var g="spotify:playlist:"+y;let t=0;var v=c.items.length;for(let e=0;e<c.items.length;e+=100){var h=c.items.slice(e,e+100);try{await Spicetify.Platform.PlaylistAPI.add(g,h,{after:"end"}),t+=h.length}catch(e){console.warn(S+": failed to add a chunk",e)}}if(t===v){Spicetify.showNotification(S+": Exported to "+f);try{var b=Spicetify.URI.playlistV2URI(y),x=null==b?void 0:b.toURLPath(!0),q=Spicetify.Platform.History;if(x)if(null!=q&&q.push)try{q.push(x)}catch(e){q.push({pathname:x})}else window.location.hash=x}catch(e){}}else Spicetify.showNotification(`${S}: Exported; some tracks couldn't be added (${t}/${v})`);try{console.log(S+": Export result",{snapshotId:c.id,totalExpected:v,totalAdded:t})}catch(e){}}else Spicetify.showNotification(S+": Nothing to export")}catch(e){console.error(S+": export failed",e),Spicetify.showNotification(S+": Failed to export to playlist")}finally{d&&(d.disabled=!1,M(d,"Export"))}await 0,E.delete(t)}}else if("replace-queue"===e){if(!E.has(t)){E.add(t);try{w.getSettings().promptManualBeforeReplace&&await H({title:"Save current queue?",message:"Create a manual snapshot of the current queue before replacing it?",confirmLabel:"Save snapshot",cancelLabel:"Skip",tone:"primary"})&&(await V(),T()),await(async(e,a)=>{try{if(e.items.length){a&&(a.disabled=!0,M(a,"Replacing…"));var i=e.items.slice(),n=i.shift();try{await Spicetify.Platform.PlayerAPI.clearQueue()}catch(e){console.warn(S+": clearQueue failed (non-fatal)",e)}try{await Spicetify.Player.playUri(n)}catch(e){try{await Spicetify.Platform.PlayerAPI.play({uri:n},{},{})}catch(e){return console.warn(S+": failed to start first track",e),void Spicetify.showNotification(S+": Failed to start snapshot")}}await new Promise(e=>setTimeout(e,250));let t=0;for(let e=0;e<i.length;e+=100){var s=i.slice(e,e+100).map(e=>({uri:e}));try{await Spicetify.Platform.PlayerAPI.addToQueue(s),t+=s.length}catch(e){console.warn(S+": addToQueue chunk failed",e)}}t===i.length?Spicetify.showNotification(`${S}: Queue replaced (${e.items.length} items)`):Spicetify.showNotification(`${S}: Replaced; some items couldn't be queued (${t+1}/${e.items.length})`)}else Spicetify.showNotification(S+": Snapshot is empty")}catch(e){console.error(S+": replace queue failed",e),Spicetify.showNotification(S+": Failed to replace queue")}finally{a&&(a.disabled=!1,M(a,"Replace queue"))}})(o,a)}finally{E.delete(t)}}}else"delete"===e&&(await H({title:"Delete snapshot",message:"Delete this snapshot? This cannot be undone.",confirmLabel:"Delete",tone:"danger"})?(A(N().filter(e=>e.id!==t)),T()):E.delete(t))}}}}}}},v=function(e){var t,a=document.querySelector(".qs-container"),i=e.target;a&&i&&a.contains(i)&&(e.stopPropagation(),"qs-auto-enabled"===i.id?(a=!!i.checked,e=w.getSettings(),e=d(c({},e),{autoEnabled:a}),w.setSettings(e),j(),n()):"qs-auto-mode"===i.name?(a=i,e=w.getSettings(),a="on-change"===a.value?"on-change":"timer",e=d(c({},e),{autoMode:a}),w.setSettings(e),n()):"qs-only-new"===i.id?(a=!!i.checked,e=w.getSettings(),e=d(c({},e),{onlyNewItems:a}),w.setSettings(e)):"qs-auto-interval-mins"===i.id?(a=i,e=w.getSettings(),a=parseFloat(a.value),a=isFinite(a)&&.5<=a?a:e.autoIntervalMs/6e4,e=d(c({},e),{autoIntervalMs:Math.round(6e4*a)}),w.setSettings(e)):"qs-max-autos"===i.id?(a=i,e=w.getSettings(),a=parseInt(a.value,10),a=Number.isFinite(a)&&0<a?a:e.maxAutosnapshots,e=d(c({},e),{maxAutosnapshots:a}),w.setSettings(e),a=e,t=(e=h()).filter(e=>"manual"===e.type),e=e.filter(e=>"auto"===e.type).slice(0,a.maxAutosnapshots),A([...t,...e]),T()):"qs-queue-warn-enabled"===i.id?(a=i.checked,t=w.getSettings(),e=d(c({},t),{queueWarnEnabled:a}),w.setSettings(e),n()):"qs-queue-max-size"===i.id?(a=i,e=w.getSettings(),a=parseInt(a.value,10),a=Number.isFinite(a)&&1<a?a:e.queueMaxSize,e=d(c({},e),{queueMaxSize:a}),w.setSettings(e)):"qs-queue-warn-threshold"===i.id?(a=i,e=w.getSettings(),a=parseInt(a.value,10),a=Number.isFinite(a)&&0<=a?a:e.queueWarnThreshold,e=d(c({},e),{queueWarnThreshold:a}),w.setSettings(e)):"qs-prompt-manual-before-replace"===i.id&&(a=i.checked,e=w.getSettings(),i=d(c({},e),{promptManualBeforeReplace:a}),w.setSettings(i)))},document.addEventListener("click",g,!0),document.addEventListener("change",v,!0),n()}function T(){j();var e,t=document.getElementById("qs-list");t&&(e=X(),t.innerHTML=e||'<div style="opacity:0.7">No snapshots yet</div>')}function Z(){let i=[],t=null,s=[],o=null,r=null;function l(){null!==t&&(clearInterval(t),t=null)}async function c(e){try{if(e.autoEnabled){var a=await x();if(a.length){if(e.onlyNewItems){let t=new Set(i);if(!a.some(e=>!t.has(e)))return void(i=a)}((t,a)=>{if(t.length===a.length){for(let e=0;e<t.length;e++)if(t[e]!==a[e])return;return 1}})(a,i)||(O({id:B(),createdAt:Date.now(),type:"auto",items:a},e),i=a)}else console.log(S+": queue is empty, skipping auto snapshot")}}catch(e){console.error(S+": auto snapshot error",e),Spicetify.showNotification(S+": failed to save an automatic snapshot")}}function d(e){l(),e.autoEnabled&&(t=window.setInterval(()=>c(e),e.autoIntervalMs),r=e.autoIntervalMs)}function u(){for(var e of s)e();s=[]}return{startAutoTimer:d,primeFromExisting:function(){var e,t=h()[0];null!=(e=null==t?void 0:t.items)&&e.length&&(i=t.items.slice())},applyAutoMode:function(e){var t=e.autoEnabled?e.autoMode:null;if(t===o)"timer"===t&&r!==e.autoIntervalMs&&d(e);else{if("on-change"===o?u():"timer"===o&&l(),"on-change"===t){var a,i,n=e;if(u(),n.autoEnabled)try{let e=null==(i=null==(a=null==Spicetify?void 0:Spicetify.Player)?void 0:a.origin)?void 0:i._events;if(null==e||!e.addListener||null==e||!e.removeListener)throw new Error("queue_update events API not available");let t=e=>{c(n),console.log(S+": queue_update",e)};e.addListener("queue_update",t),s.push(()=>{try{e.removeListener("queue_update",t)}catch(e){console.error(S+": failed to remove queue_update listener",e)}})}catch(e){console.error(S+": failed to start queue update watcher",e),Spicetify.showNotification(S+": failed to start queue update watcher")}}else"timer"===t&&d(e);o=t}}}}function ee(r){let n=null,l=null,c=0,d=3e4;async function s(){try{var e,t,a,i,n,s,o=r();o.queueWarnEnabled&&(e=o.queueMaxSize,(t=o.queueWarnThreshold)<0||e<=1||(a=await x()).length&&(i=Math.max(0,e-a.length))<=t&&(n=Date.now(),l!==i||n-c>=d)&&(s=e-i,Spicetify.showNotification(S+`: Queue nearly full (${s}/${e})`,!1,2500),l=i,c=n))}catch(e){console.warn(S+": queue capacity check failed",e)}}function e(){if(n){try{n()}catch(e){}n=null}}return{start:function(){var a,i;e();try{let e=null==(i=null==(a=null==Spicetify?void 0:Spicetify.Player)?void 0:a.origin)?void 0:i._events;if(null==e||!e.addListener||null==e||!e.removeListener)throw new Error("queue_update events API not available");let t=e=>{s()};e.addListener("queue_update",t),n=()=>{try{e.removeListener("queue_update",t)}catch(e){console.error(S+": failed to remove queue_update listener (capacity watcher)",e)}},s()}catch(e){console.error(S+": failed to start capacity watcher",e),Spicetify.showNotification(S+": failed to start capacity watcher")}},stop:e,checkAndWarnOnce:s}}i=Object.defineProperty,a=Object.defineProperties,n=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,l=(e,t,a)=>t in e?i(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,c=(e,t)=>{for(var a in t=t||{})o.call(t,a)&&l(e,a,t[a]);if(s)for(var a of s(t))r.call(t,a)&&l(e,a,t[a]);return e},p={autoEnabled:!(u="queue-manager:settings"),autoIntervalMs:3e5,maxAutosnapshots:20,autoMode:"timer",onlyNewItems:!0,queueWarnEnabled:!0,queueMaxSize:80,queueWarnThreshold:5,promptManualBeforeReplace:!(d=(e,t)=>a(e,n(t)))},f="queue-manager:snapshots",S="Queue Manager",m="0.3.1",y="beta",k=new Map,q=!1,v=g=null,E=new Set,$=new Map,W=16,e=async function(){for(var e;null==Spicetify||!Spicetify.showNotification||null==Spicetify||!Spicetify.CosmosAsync||null==Spicetify||!Spicetify.LocalStorage;)await new Promise(e=>setTimeout(e,100));let t=R(),a=Z(),i=(a.primeFromExisting(),a.applyAutoMode(t),ee(()=>t)),n=(i.start(),{getSettings:()=>t,setSettings:e=>{t=e,Spicetify.LocalStorage.set(u,JSON.stringify(e)),a.applyAutoMode(e),i.checkAndWarnOnce()}});try{null!=(e=null==Spicetify?void 0:Spicetify.Topbar)&&e.Button&&new Spicetify.Topbar.Button(S,"queue",()=>w(n),void 0,!0)}catch(e){console.error(S+": failed to add topbar button")}try{new Spicetify.ContextMenu.Item(S,()=>w(n),(e,t,a)=>{var i,n,s;try{if(a){var o=Spicetify.URI.fromString(a);if((null==o?void 0:o.type)===Spicetify.URI.Type.QUEUE)return!0;if(a.includes(":queue"))return!0}return((null==(s=null==(n=null==(i=Spicetify.Platform)?void 0:i.History)?void 0:n.location)?void 0:s.pathname)||"").includes("queue")}catch(e){}return!1},"queue").register()}catch(e){console.error(S+": failed to add context menu item")}try{Spicetify.Keyboard.registerShortcut({key:"q",ctrl:!0,alt:!0},()=>w(n))}catch(e){console.error(S+": failed to add keyboard shortcut")}},(async()=>{await e()})(),(async()=>{var e;document.getElementById("queueDmanager")||((e=document.createElement("style")).id="queueDmanager",e.textContent=String.raw`
  .qs-container{display:flex;flex-direction:column;gap:18px;overflow:visible}.qs-header{display:flex;justify-content:space-between;align-items:center;padding:16px;border-radius:12px;background:linear-gradient(135deg,rgba(52,211,153,.16),rgba(37,99,235,.12));border:1px solid rgba(255,255,255,.06);gap:12px}.qs-header-title{display:flex;align-items:center;gap:12px;font-weight:600}.qs-header-text{display:flex;flex-direction:column;gap:4px}.qs-header-app{display:flex;align-items:center;gap:10px}.qs-header-badges{display:inline-flex;gap:6px;align-items:center}.qs-header-icon{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:50%;background:rgba(0,0,0,.4)}.qs-header-name{font-size:18px}.qs-header-sub,.qs-header-sub-alt{font-size:13px;opacity:.75}.qs-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}.qs-settings{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:18px;padding:16px;border-radius:12px;background:var(--spice-section-bg,rgba(255,255,255,.05));border:1px solid rgba(255,255,255,.05);overflow:visible}.qs-settings-header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px}.qs-right{display:flex;flex-direction:column;gap:16px}.qs-setting{display:flex;flex-direction:column;gap:6px}.qs-setting label{font-weight:600;display:inline-flex;align-items:center;gap:8px}.qs-dim{color:rgba(255,255,255,.7);font-size:12px}.qs-row{display:flex;flex-direction:column;gap:12px;padding:12px 16px;border-radius:10px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.04);box-shadow:0 10px 30px rgba(0,0,0,.25)}.qs-row+.qs-row{margin-top:12px}.qs-row-main{display:flex;flex-direction:column;gap:10px}.qs-row-title{font-weight:600;display:inline-flex;align-items:center;gap:8px}.qs-title-actions{display:inline-flex;align-items:center;gap:6px;margin-left:8px}.qs-icon-btn{display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:0 0;border:1px solid transparent;cursor:pointer;padding:0;transition:background .15s ease,transform .12s ease,border .12s ease;color:inherit}.qs-icon-btn:hover{background:linear-gradient(135deg,rgba(96,165,250,.35),rgba(59,130,246,.2));border-color:rgba(96,165,250,.4);transform:translateY(-1px)}.qs-icon-btn:focus-visible{outline:2px solid rgba(96,165,250,.8);outline-offset:2px}.qs-icon-btn .qs-svg-icon{width:16px;height:16px}.qs-row-meta{display:flex;flex-wrap:wrap;gap:6px;font-size:12px;align-items:center}.qs-row-actions{display:flex;flex-wrap:nowrap;gap:10px;padding:2px 0;overflow-x:auto}.qs-row-actions .qs-btn{flex:0 0 auto;justify-content:flex-start}.qs-btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:6px 10px;border-radius:8px;background:rgba(255,255,255,.08);color:inherit;border:1px solid transparent;cursor:pointer;font-weight:600;transition:transform .12s ease,box-shadow .12s ease,border .12s ease;text-decoration:none}.qs-btn.primary{background:linear-gradient(135deg,rgba(96,165,250,.9),rgba(59,130,246,.9));border-color:rgba(96,165,250,.35)}.qs-btn.subtle{background:rgba(255,255,255,.04);border-color:rgba(255,255,255,.08)}.qs-btn.danger{background:rgba(248,113,113,.16);border-color:rgba(248,113,113,.25)}.qs-btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(0,0,0,.25)}.qs-btn:focus-visible{outline:2px solid rgba(96,165,250,.8);outline-offset:2px}.qs-btn-icon{display:inline-flex;align-items:center;justify-content:center}.qs-btn-label{white-space:nowrap}.qs-svg-icon{display:block;fill:currentColor;width:16px;height:16px}.qs-section-card{display:flex;flex-direction:column;gap:12px;padding:16px;border-radius:12px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.05)}.qs-section-head{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:center}.qs-section-heading{display:inline-flex;align-items:center;gap:12px;font-weight:600}.qs-section-text{display:flex;flex-direction:column;gap:2px}.qs-section-name{font-size:16px}.qs-section-caption{font-size:12px;opacity:.75}.qs-section-body{display:flex;flex-direction:column}.qs-empty{opacity:.6;font-size:13px;padding:12px}.qs-input{padding:8px 10px;border-radius:8px;background:rgba(0,0,0,.25);color:inherit;border:1px solid rgba(255,255,255,.1);font-size:14px}.qs-input:disabled{opacity:.6;cursor:not-allowed}.qs-checkbox{display:inline-flex;align-items:center;gap:10px}.qs-radio-group{display:inline-flex;gap:12px;align-items:center;margin-top:6px}.qs-radio-label span{display:inline-flex;align-items:center;gap:6px}.qs-icon{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;font-size:12px;line-height:16px;margin-left:2px;position:relative}.qs-icon-glyph{opacity:.7;transition:opacity .12s ease-in-out}.qs-icon:hover .qs-icon-glyph{opacity:1}.qs-icon>.qs-tooltip{position:absolute;left:50%;transform:translateX(-50%);bottom:calc(100% + 6px);white-space:nowrap;text-align:left;padding:8px 10px;border-radius:4px;font-size:12px;background:#121212;border:1px solid rgba(255,255,255,.08);box-shadow:0 4px 14px rgba(0,0,0,.35);color:var(--spice-text,#fff);pointer-events:none;opacity:0;transition:opacity .12s ease-in-out;z-index:9999}.qs-icon:hover>.qs-tooltip{opacity:1}.qs-tooltip .qs-tooltip-emph{color:#ff4e4e}.qs-radio:disabled{cursor:not-allowed}.qs-radio:disabled+span{opacity:.6;cursor:not-allowed}.qs-inline-input{padding:6px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.45);color:inherit;font-size:14px;width:100%;max-width:240px}.qs-dialog-input{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.35);color:inherit;font-size:14px}.qs-items{margin:10px 0 14px 0;padding:12px;border-left:2px solid rgba(59,130,246,.35);background:rgba(59,130,246,.12);border-radius:8px}.qs-items-body{display:flex;flex-direction:column;gap:4px;font-size:13px;max-height:240px;overflow:auto}.qs-pill{display:inline-flex;align-items:center;justify-content:center;padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.12);font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px}.qs-pill--accent{background:linear-gradient(135deg,rgba(59,130,246,.85),rgba(99,102,241,.85))}.qs-pill--version{background:rgba(255,255,255,.12)}.qs-pill--channel{background:rgba(248,113,113,.35)}.qs-confirm-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:100;backdrop-filter:blur(2px)}.qs-confirm-dialog{background:var(--spice-section-bg,rgba(32,32,32,.95));border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:20px 22px;max-width:360px;width:min(90vw,360px);box-shadow:0 18px 36px rgba(0,0,0,.45);display:flex;flex-direction:column;gap:16px}.qs-confirm-title{font-size:16px;font-weight:600}.qs-confirm-message{font-size:13px;opacity:.85;line-height:1.5}.qs-confirm-actions{display:flex;gap:10px;justify-content:flex-end}@media (max-width:860px){.qs-header{flex-direction:column;align-items:flex-start}.qs-actions{width:100%;justify-content:flex-start}.qs-row{grid-template-columns:1fr}.qs-row-actions{grid-template-columns:repeat(auto-fit,minmax(120px,1fr))}}
      `.trim(),document.head.appendChild(e))})()})();